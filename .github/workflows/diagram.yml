name: Update Architecture Diagram

# Regenerates docs/architecture.png whenever the agent/skill/harness code
# changes on main. The auto-commit uses [skip ci] to prevent a loop.
# Does NOT run on pull_requests — the diagram committed on main is shown
# via the PR template's embedded image link.

on:
  push:
    branches: [main]
    paths:
      - "skills/**"
      - "harness/**"
      - "scripts/**"
      - "agents/**"
      - "config/**"

permissions:
  contents: write

jobs:
  diagram:
    name: Regenerate architecture diagram
    runs-on: ubuntu-latest

    # Skip when the previous push was itself the diagram auto-commit,
    # preventing an infinite trigger loop.
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies (Graphviz)
        run: sudo apt-get install -y graphviz --no-install-recommends

      - name: Install diagrams library
        run: pip install "diagrams>=0.23.4"

      - name: Generate diagram
        run: python3 scripts/gen_diagram.py

      - name: Commit if changed
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/architecture.png
          if git diff --staged --quiet; then
            echo "Architecture diagram unchanged — nothing to commit."
          else
            git commit -m "chore(diagram): regenerate reference architecture [skip ci]"
            git push
            echo "Architecture diagram updated and pushed."
          fi
